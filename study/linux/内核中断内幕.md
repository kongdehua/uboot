# Linux内核中断内幕
本文对中断系统进行全面的分析与探讨，主要包括中断控制器、中断分类、中断亲和力、中断线程化与SMP的中断迁徙等。首先对中断工作原理进行了简要分析，接着详细探讨了中断亲和力的实现原理，最后对中断线程化与非线程化中断之间的实现机理进行了对比。

## 什么是中断
Linux内核需要对连接到计算机上的所有硬件设备进行管理，毫无疑问这是它的分内事。如果要管理这些设备，首先要和它们互相通信才行，方案如下：

1. 轮询（polling）让内核定期对设备的状态进行查询，然后做出相应的处理；
2. 中断（interrupt）让硬件在需要的时候向内核发出信号（变内核主动为硬件主动）

一般都采用第二种方案。

从物理学的角度看，中断是一种电信号，由硬件设备产生，并直接送入中断控制器的输入引脚上，然后再由中断控制器向处理器发送相应的信号。处理器一经检测到该信号，便中断自己当前正在处理的工作，转而去处理中断。此后处理器会通知OS一经产生中断。这样，OS可以对这个中断进行适当的处理。不同的设备对应的中断不同，而每个中断都通过一个唯一的数字标识，这些值通常被称为中断请求先。

## APIC vs 8259A
X86计算机的CPU为中断只提供了两条外接引脚：NMI和INTR。
1. 其中NMI是不可屏蔽中断，它通常用于电源掉电和物理存储奇偶校验；
2. INTR是可屏蔽中断，可以通过设置中断屏蔽位来进行中断屏蔽，它主要用于接受外部硬件的中断信号，这些信号由中断控制器传递给CPU。

常见的中断控制器：
1. 可编程中断控制器8259A

传统的PIC（Programmable Interrupt Controller）是由两片8259A风格的外部芯片以“级联”的方式连接在一起。每个芯片可处理多达8个不同的IRQ。因为从PIC的INT输出线连接到PIC的IRQ2引脚，所以可用IRQ线的个数达到15个。
2. 高级可编程中断控制器（APIC）
8259A只适合单CPU的情况，为了充分挖掘SMP体系结构的并行性，能够把中断传递给系统中的每个CPU至关重要。基于此理由，Intel引入一种名为I/O高级可编程控制器的新组件，来替代老式的8259A可编程中断控制器。该组件包含两个组成部分：一是“本地APIC”，主要负责传递中断信号到指定的处理器；举例：一台具有3个处理器的机器，则它必须相对的要有三个本地APIC。另外一个重要的部分是I/O APIC，主要是收集来自I/O装置的Interrupt信号，且在当那些装置需要中断时发送信号到本地APIC，系统中最多可拥有8个I/O APIC。

每个本地APIC都有32位的寄存器，一个内部时钟，一个本地定时设备以及为本地中断保留的两条额外的IRQ线LINT0和LINT1。所有本地APIC都连接到I/O APIC，形成一个多级APIC系统。

目前大部分单处理器都包含一个I/O APIC芯片，可以通过以下两种方式来对这种芯片进行配置：
1. 作为一种标准的8259A工作方式。本地APIC被禁止，外部I/O APIC连接到CPU，两条LINT0和LINT1分别连接到INTR和NMI引脚。
2. 作为一种标准外部I/O APIC。本地APIC被激活，且所有的外部中断都通过I/O APIC接收。

辨别一个系统是否正在使用I/O APIC，可以在命令行输入如下命令。

## 中断分类
中断可分为同步（synchronous）中断和异步（asynchronous）中断：
1. 同步中断是当指令执行时由CPU控制单元产生，之所以成为同步，是因为只有在一条指令执行完毕后CPU才会发出中断，而不是发生在代码执行期间，比如系统调用。

2. 异步中断是指由其他硬件设备依照CPU时钟信号随机产生，即意味着中断能够在指令之间发生，例如键盘中断。

根据Intel官方资料，同步中断称为异常，异步中断成为中断。

中断可分为可屏蔽中断和非屏蔽中断。异常可分为故障、陷阱、终止三类。

X86体系结构的每个中断都被赋予一个唯一的编号或者向量（8位无符号整数）。非屏蔽中断和异常向量是固定的，而可屏蔽中断向量可以通过对中断控制器的编程来改变。

## Linux 2.6 中断处理原理简介
中断描述符表（Interrupt Descriptor Table，IDT）是一个系统表，它与每一个中断或异常向量相联系，每一个向量在表中存放的是相应的中断或异常处理程序的入口地址。内核在允许中断发生前，也就是在系统初始化时，必须把IDT表的初始化地址装载到idtr寄存器中，初始化表中的每一项。

当处于实模式下时，IDT被初始化并由BIOS程序使用。然而，一旦Linux开始接管，IDT就被移到RAM中的另一个区域，并进行第二次初始化，因为Linux不使用任何BIOS程序，而使用自己专门的中断服务程序。中断和异常处理程序很像常规的C函数。

有三个主要的数据结构包含了与IRQ相关的所有信息：hw_interrupt_type、irq_desc_t和irqaction.

在中断初始化阶段，调用hw_interrupt_type类型的变量初始化irq_desc_t
