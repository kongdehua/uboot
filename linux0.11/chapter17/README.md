# 实验环境与设置方法
本章介绍利用PC机仿真软件和在实际计算机上运行linux 0.11系统的方法。其中包括：
* 内核编译过程
* PC仿真环境下文件的访问和复制
* 引导盘和根文件系统的制作方法
* Linux 0.11系统的使用方法
* 如何进行少量语法修改，可以在新版本gcc上编译，并制作内核映像文件

## 开发环境
### Windows平台
* Bochs 2.2.x开发源代码的PC机仿真软件包
* UltraEdit 超级编辑器，可以编辑二进制文件
* WinImage DOS格式软盘映像文件的读写软件

### Linux系统
只需安装Bochs软件包即可。其他操作linux系统都支持

运行linux 0.11系统的最佳方法是使用PC仿真软件。目前市面上流行的PC仿真系统主要有3种：
* VMware公司的VMware Workstation

  仅仅仿真了一些I/O功能，其他所有部分则是在x86实时硬件上直接执行。也就是说当客户操作系统在要求执行一条指令时，VMware不是用仿真软件来模拟这条指令，而是把这条指令“传递”给实际系统的硬件来完成。因此VMware是三种软件中运行速度和性能最高的一种。

* Connectix公司的Virtual PC

  性能介于Bochs和VMware Workstation之间。它仿真了x86的大部分指令，而其它部分采用虚拟技术来实现。

* 开源代码软件Bochs

  仿真了x86的硬件环境及其外围设备，因此很容易被移植到很多操作系统上或者不同体系结构的平台上。由于使用了仿真技术，运行性能和速度都要比两个软件要慢得多。

从应用方面来看：
* 如果主要用于应用程序开发，那么VMware Workstation和Virtual PC可能是比较好的选择。
* 如果需要开发一些底层系统软件，比如操作系统开发和调试、编译系统开发等，那么Bochs是一个很好的选择。

Bochs可以知道被执行程序在仿真硬件环境中的具体状态和精确时序，而非实际硬件系统执行的结果。这也是为什么很多操作系统开发者更倾向于使用Bochs的原因。

## 1. Bochs仿真软件系统
Bochs是一个能完全仿真Intel x86计算机的程序。它可以被配置成仿真386、486、Pentium或以上的新型CPU。在执行的整个过程，Bochs仿真了所有的指令，并且含有标准PC机外设所有的设备模块。由于Bochs仿真了整个PC环境，因此在其中执行的软件会“认为”它是在一个真实的机器上运行。这种完全仿真的方法使得我们能在Bochs下不加修改地运行大量的软件系统。

Bochs是Kevin Lawton于1994年开始采用C++语言开发的软件系统，被设计成能够在Intel x86、PPC、Alpha、Sun和MIPS硬件上运行。不管运行的主机采用的是何种硬件平台，Bochs仍然能仿真x86平台。为了在被模拟的机器上执行任何活动，Bochs需要与主机操作系统进行交互。当Bochs显示窗口中按下一个键时，一个击键事件就会发送到键盘的设备处理模块中。当被模拟的机器需要从模拟的硬盘上执行读操作时，Bochs就会从主机上的硬盘映像文件中执行读操作。

### Bochs安装
* Windows安装：双击exe
* Linux安装：rpm -i bochs-...rpm

  Linux系统中必须安装X Window才能使用Bochs。

### Bochs测试
安装完成Bochs后，建议使用Bochs自带的Linux dlx系统程序包来测试和熟悉一下Bochs系统。另外也可以从Bochs网站上下载一些已经制作好的Linux磁盘映像文件。建议下载Bochs网站上的SLS Linux模拟系统：sls-0.99p1.tar.bz2作为创建linux 0.11模拟系统的辅助平台。在我们制作新的硬盘映像文件时，需要借助这些系统对硬盘映像文件进行分区和格式化操作。下载的文件解压后进入其目录并双击bochsrc.bxrc配置文件名，可以运行SLS Linux系统。

### 1.1 设置Bochs系统
为了在Bochs中运行一个操作系统，最少需要一下资源
* bochs执行文件
* bios映像文件：通常称为BIOS-bochs-latest
* vgs bios映像文件：例如，VGABIOS-lgpl-latest
* 至少一个引导启动磁盘映像文件（软盘、硬盘或CDROM的映像文件）

但是我们在使用过程中往往需要为运行系统预先设置一些参数。这些参数可以在命令行上传递给Bochs执行程序，但通常我们都是用一个配置文件（文件后缀为.bxrc，例如Sample.bxrc）为专门的一个应用来设置运行参数。

### 1.2 配置文件 `*.bxrc`
Bochs使用配置文件中的信息来寻找所使用的磁盘映像文件、运行环境外围设备的配置以及其他一些模拟机器的设置信息。每个被仿真的系统都需要设置一个相应的配置文件。若被安装的Bochs系统是2.1或以后系统，那么Bochs系统自动识别后缀是‘.bxrc’的配置文件，并且在双击该文件图片时，就会自动Bochs系统运行。例如，我们可以把配置文件名改为‘bochsrc-0.11.bxrc’。在Bochs安装的主目录下有一个名称位‘bochsrc-sample.txt’的样板配置文件，其中列出了所有可用的参数设置，并带有详细的说明。下面简单介绍几个在实验中哦你经常要修改的参数。

* megs

  用于设置被模拟系统所含内存容量。默认值为32MB。例如，如果要把模拟机器设置位含有128MB的系统，则需要在配置文件中含有如下一行：

```
---------------------------------------------------------
  megs: 128
---------------------------------------------------------
```

* floppya (floppyb)

  floppya表示第一个软驱，floppyb代表第二个软驱。如果需要从一个软盘来引导系统，那么floppya就需要指向一个可引导的磁盘。若想使用磁盘映像文件，那么我们就在该选项后面写上磁盘映像文件的名称。在许多操作系统中，Bochs可以直接写主机系统的软盘驱动器。若要访问这些实际驱动器这些实际驱动器中的磁盘，就是用设备名称（linux系统）或驱动器号（Windows系统）。还可以使用status来表明磁盘的插入状态。ejected表示未插入，inserted表示磁盘已插入。下面几个例子均为已插入状态。

  若配置文件中同时存在几行相同名称的参数，那么只有最后一行的参数起作用。

  ```
  ---------------------------------------------------------
  floppya: 1_44=/dev/fd0, status=inserted     # Linux系统下直接访问A盘
  floppya: 1_44=b:,       status=inserted     # Win32系统下直接访问A盘
  floppya: 1_44=bootimage.img,status=inserted # 指向磁盘映像文件
  floppyb: 1_44=../image.img, status=inserted # 指向上级目录中的映像文件
  ---------------------------------------------------------
  ```

* ata0, ata1, ata2, ata3
这四个参数用来启动模拟系统中最多4个ATA通道。对于每个启用的通道必须指明两个IO基地址和一个中断请求号。默认情况下只有ata0是启用的，并且参数默认为下面所示的值：

  ```
  ---------------------------------------------------------
  ata0: enabled=1, ioaddr1=0x1f0, ioaddr2=0x3f0, irq=14
  ata1: enabled=1, ioaddr1=0x170, ioaddr2=0x370, irq=15
  ata2: enabled=1, ioaddr1=0x1e8, ioaddr2=0x3e0, irq=11
  ata3: enabled=1, ioaddr1=0x168, ioaddr2=0x360, irq=9
  ---------------------------------------------------------
  ```

* ata0-master (ata0-slave)
ata0-master用来指明模拟系统中第一个ATA通道上连接的第一个ATA设备（硬盘或CDROM等）；ata0-slave指明第一个通道上连接的第二个ATA设备。示例如下，其中，设备配置的选项含义。

## 3. 访问磁盘映像文件中的信息
Bochs使用磁盘映像文件来仿真被模拟系统中外部存储设备，被模拟操作系统中的所有文件均以软盘或硬盘设备中的格式保存在映像文件中。由此就带来了主机操作系统与Bochs中被模拟系统之间交换信息的问题。虽然Bochs系统能被配置成直接使用的软盘驱动器、CDROM驱动器等物理设备来运行，但是利用这种信息交换方法比较奥繁琐。因此最好能够直接读写Image文件中的信息。如果需要往被模拟的操作系统中添加文件，就把文件存入Image文件中。如果要取出其中的文件就从Image文件中读出。但由于保存在Image文件中的信息不仅是按照相应的软盘或硬盘格式存放，而且还以一定的文件系统格式存放。因此访问Image文件中信息
